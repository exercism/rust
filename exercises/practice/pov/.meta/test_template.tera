/// Forbid implementations that rely on Clone.
mod no_clone {
    use pov::*;

    #[derive(Debug, PartialEq, Eq, PartialOrd, Ord)]
    struct NotClone;

    #[test]
    #[ignore]
    fn doesnt_rely_on_clone() {
        let mut tree = Tree::new(NotClone);
        assert!(tree.pov_from(&NotClone));
    }
}

/// Equality on trees must be independent of the order of children.
mod equality {
    use pov::*;
    use pretty_assertions::assert_eq;

    #[test]
    #[ignore]
    fn equality_is_order_independent() {
        let a = Tree::new("root").with_child(Tree::new("left")).with_child(Tree::new("right"));
        let b = Tree::new("root").with_child(Tree::new("right")).with_child(Tree::new("left"));
        assert_eq!(a, b);
    }
}

{% macro render_tree(tree) -%}
    Tree::new("{{ tree.label }}")
    {%- if tree.children -%}{%- for child in tree.children -%}
            .with_child({{ self::render_tree(tree=child) }})
    {%- endfor -%}{%- endif -%}
{%- endmacro -%}

{%- macro render_vec(values) -%}
vec![
    {%- for value in values -%}
        &"{{ value }}",
    {%- endfor -%}
]
{%- endmacro -%}

{% for test_group in cases %}
/// {{ test_group.description }}
mod {{ test_group.cases[0].property | make_ident }} {
    use pov::*;
    use pretty_assertions::assert_eq;

{% for test in test_group.cases %}
#[test]
#[ignore]
fn {{ test.description | make_ident }}() {
    let mut tree = {{ self::render_tree(tree=test.input.tree) }};
    {%- if test.property == "fromPov" -%}
        {%- if not test.expected -%}
            assert!(!tree.pov_from(&"{{ test.input.from }}"));
        {%- else -%}
            assert!(tree.pov_from(&"{{ test.input.from }}"));
            let expected = {{ self::render_tree(tree=test.expected) }};
            assert_eq!(tree, expected);
        {%- endif -%}
    {%- elif test.property == "pathTo" -%}
        let result = tree.path_between(&"{{ test.input.from }}", &"{{ test.input.to }}");
        {%- if not test.expected -%}
            let expected: Option<Vec<_>> = None;
        {%- else -%}
            let expected = Some({{ self::render_vec(values=test.expected) }});
        {%- endif -%}
        assert_eq!(result, expected);
    {%- else -%}
        Invalid property: {{ test.property }}
    {%- endif -%}
}
{% endfor %}
}
{% endfor %}
